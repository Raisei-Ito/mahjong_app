# 麻雀スコア管理アプリ

**デプロイ済みのWebアプリケーション** | [GitHubリポジトリ](https://github.com/[ユーザー名]/mahjong_app) | [デモサイト](https://your-app-name.onrender.com)

麻雀の半荘ごとのスコアとチップを記録・共有するWebアプリケーションです。4人で行う麻雀の対戦結果をリアルタイムで共有し、複雑なスコア計算を自動化することで、正確な収支管理を実現します。

---

## アプリケーション概要

このアプリケーションは、実際に使用されているデプロイ済みのWebアプリケーションです。麻雀という複雑なルールを持つゲームのスコア計算を自動化し、複数人で同時に使用できるリアルタイム共有機能を実装しています。

### 主な機能

- **部屋作成・共有**: 6桁の英数字コードで部屋を作成し、複数人で共有
- **プレイヤー管理**: 4名のプレイヤーを登録・管理
- **スコア記録**: 持ち点とチップ増減を記録
- **自動計算**: ウマ・オカ・チップ換算を考慮したポイントを自動計算
- **リアルタイム更新**: HTMXによる非同期通信で3分ごとに自動更新
- **柔軟な設定**: 9種類のレート設定とカスタムサシウマ設定に対応
- **統計表示**: ゲーム履歴と累計成績を自動集計・表示

---

## 技術スタック

### バックエンド
- **Python 3.11** - 最新のPython機能を活用
- **Django 5.2+** - MVTアーキテクチャによる保守性の高い設計
- **SQLite** - 小規模運用に適した軽量データベース

### フロントエンド
- **Django Templates** - サーバーサイドレンダリングによるSEO対応
- **Bootstrap 5** - レスポンシブデザインで全デバイス対応
- **HTMX** - 軽量な非同期通信ライブラリによるUX向上

### インフラ・デプロイ
- **Render** - クラウドプラットフォームでデプロイ
- **Gunicorn** - 本番環境用WSGIサーバー
- **WhiteNoise** - 静的ファイルの効率的な配信

---

## 設計の工夫点

### 1. 保守性を重視したアーキテクチャ設計

**問題**: 麻雀のスコア計算は複雑で、ルール変更に対応しやすい設計が必要

**解決策**:
- データモデルを4つのエンティティ（Room, Player, Game, ScoreRecord）に分離
- ビジネスロジックをモデルのプロパティメソッドに集約
- ビュー関数をシンプルに保ち、責務を明確に分離

```python
# 例: サシウマからウマを自動計算するプロパティ
@property
def uma_1st(self):
    """1位ウマ（サシウマから計算）"""
    _, uma_3_4 = self._get_sashi_uma_values()
    return uma_3_4
```

**効果**: ルール変更時もモデルのプロパティを修正するだけで対応可能

### 2. データ整合性の保証

**問題**: スコア記録時に複数のデータを同時に更新する必要がある

**解決策**:
- `transaction.atomic()`デコレータを使用したトランザクション管理
- エラー発生時の自動ロールバック
- 持ち点の合計検証による入力値の妥当性チェック

**効果**: データの不整合を防ぎ、信頼性の高いアプリケーションを実現

### 3. UXを意識した非同期通信

**問題**: 複数人で同時に使用する際、最新情報をリアルタイムで共有したい

**解決策**:
- HTMXによる軽量な非同期通信を実装
- 3分ごとの自動更新でページリロード不要
- パーシャルテンプレートによる部分更新

**効果**: ページリロードなしで最新情報を表示し、ユーザー体験を向上

### 4. 柔軟な設定システム

**問題**: 麻雀には様々なルールがあり、設定変更に対応する必要がある

**解決策**:
- サシウマ設定をタイプ化（5-10、10-20、10-30、カスタム）
- レート設定を9種類から選択可能
- プロパティメソッドで設定から自動計算

**効果**: ユーザーが好みのルールで使用でき、拡張性も確保

---

## 実装のハイライト

### 複雑なスコア計算ロジック

麻雀のスコア計算は以下の要素を含みます：
- **素点**: 持ち点から返し点を引いた値
- **ウマ**: 順位に応じたポイント（サシウマ設定から自動計算）
- **オカ**: 返し点と持ち点の差から計算
- **チップ**: チップ増減をポイントに換算

これらを自動計算するロジックを実装し、ユーザーは持ち点とチップ増減を入力するだけで正確な収支が計算されます。

### トランザクション管理によるデータ整合性

スコア記録時は以下の処理をトランザクション内で実行：
1. 新しいGame（半荘）を作成
2. 4名分のScoreRecordを作成
3. 順位を自動判定
4. ポイントを計算して保存

いずれかの処理でエラーが発生した場合、すべての変更がロールバックされ、データの整合性が保たれます。

### レスポンシブデザイン

Bootstrap 5を使用し、デスクトップ・タブレット・スマートフォンすべてで快適に使用できるUIを実現。麻雀は長時間のゲームのため、どのデバイスからでもアクセスできることが重要です。

---

## 技術選定の理由

### Djangoを選んだ理由

- **MVTアーキテクチャ**: 責務の分離が明確で保守性が高い
- **ORM**: データベース操作が安全で、マイグレーション管理が容易
- **豊富な機能**: 認証、セッション管理、CSRF保護などが標準装備

### HTMXを選んだ理由

- **軽量**: フレームワーク不要で、既存のHTMLに属性を追加するだけ
- **シンプル**: ReactやVue.jsのような複雑な状態管理が不要
- **サーバーサイドレンダリング**: SEOに有利で、Djangoとの相性が良い

### SQLiteを選んだ理由

- **小規模運用に適している**: ユーザー数が少ないため、追加のデータベースサーバーが不要
- **シンプルな運用**: 設定が不要で、開発から本番まで同じデータベースを使用可能
- **十分な性能**: 読み取り中心のアプリケーションでは十分な性能を発揮

---

## アーキテクチャ概要

データモデルは4つのエンティティ（Room, Player, Game, ScoreRecord）に分離し、適切なリレーションシップを設計しています。ビジネスロジックはモデルのプロパティメソッドに集約し、ビュー関数はシンプルに保つ設計を採用しています。

詳細なアーキテクチャについては、[アーキテクチャドキュメント](ARCHITECTURE.md)を参照してください。

---

## プロジェクト構造

```
mahjong_app/
├── mahjong/                    # メインアプリケーション
│   ├── models.py              # データモデル（ビジネスロジック含む）
│   ├── views.py               # ビュー関数
│   ├── urls.py                # URLルーティング
│   ├── templates/             # HTMLテンプレート
│   │   └── mahjong/
│   │       ├── base.html
│   │       ├── index.html
│   │       ├── dashboard.html
│   │       └── partials/      # HTMX用パーシャルテンプレート
│   ├── templatetags/          # カスタムテンプレートタグ
│   └── management/            # カスタム管理コマンド
│       └── commands/
│           └── cleanup_old_rooms.py
├── mahjong_project/           # Djangoプロジェクト設定
│   ├── settings.py            # 設定ファイル
│   ├── urls.py                # ルートURL設定
│   └── wsgi.py                # WSGI設定
├── requirements.txt           # Python依存関係
├── render.yaml                # Render設定ファイル
└── README.md                  # このファイル
```

---

## 開発環境のセットアップ（参考）

このアプリケーションは既にデプロイ済みですが、開発やカスタマイズのためにローカル環境で実行する場合：

```bash
# リポジトリをクローン
git clone https://github.com/[ユーザー名]/mahjong_app.git
cd mahjong_app

# 仮想環境を作成
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係をインストール
pip install -r requirements.txt

# 環境変数を設定（.env.exampleを参考）
cp .env.example .env

# データベースマイグレーション
python manage.py migrate

# 開発サーバーを起動
python manage.py runserver
```

---

## 関連ドキュメント

- [ポートフォリオ詳細](PORTFOLIO.md) - 開発の背景と工夫点
- [アーキテクチャドキュメント](ARCHITECTURE.md) - 詳細な設計思想と実装

---

## ライセンス

MIT License

---

## 作者

[あなたの名前]

---

**このアプリケーションは実際にデプロイされ、使用されています。技術的な質問やフィードバックは、GitHubのIssuesまたはプルリクエストでお気軽にお知らせください。**
