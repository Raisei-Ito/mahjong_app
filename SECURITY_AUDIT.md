# セキュリティ監査レポート

**作成日**: 2024年
**対象アプリケーション**: 麻雀スコア管理アプリ

## 実行サマリー

このレポートは、Djangoベースの麻雀スコア管理アプリケーションのセキュリティ監査結果をまとめたものです。

## 重大な問題（Critical）

### 1. CSRF保護の無効化 ⚠️ **CRITICAL**

**場所**: `mahjong/views.py` (482行目, 509行目)

**問題**:
```482:484:mahjong/views.py
@csrf_exempt
@require_http_methods(["GET"])
def game_list_partial(request, room_code):
```

```509:511:mahjong/views.py
@csrf_exempt
@require_http_methods(["GET"])
def player_stats_partial(request, room_code):
```

**説明**: `@csrf_exempt`デコレータにより、CSRF保護が無効化されています。ただし、これらのビューはGETリクエストのみを受け付けるため、現時点では直接的なリスクは低いです。しかし、将来的にPOSTリクエストを追加する場合、重大なセキュリティリスクとなります。

**推奨事項**:
- GETリクエストのみのビューでは`@csrf_exempt`は不要です。削除してください。
- 将来的にPOSTリクエストを追加する場合は、必ずCSRF保護を有効化してください。

### 2. 認証・認可の欠如 ⚠️ **HIGH**

**問題**: すべてのビューが認証なしでアクセス可能です。部屋コードを知っている誰でも、任意の部屋のデータを閲覧・編集・削除できます。

**影響を受けるビュー**:
- `room_setup`: プレイヤー情報の編集
- `record_score`: スコアの記録
- `room_dashboard`: ダッシュボードの閲覧
- `delete_game`: ゲームの削除
- `delete_room`: 部屋の削除
- `edit_players`: プレイヤー情報の編集
- `room_settings`: 部屋設定の変更

**推奨事項**:
- 部屋コードベースの簡易認証を実装するか、セッション管理を追加してください。
- 部屋の作成者や参加者のみがアクセスできるように制限を検討してください。
- 少なくとも、削除操作には追加の確認（例：確認画面、トークン）を実装してください。

## 中程度の問題（Medium）

### 3. デバッグログのハードコード ⚠️ **MEDIUM**

**場所**: `mahjong/views.py` (32行目, 221行目)

**問題**:
```32:36:mahjong/views.py
log_path = '/Users/raisei-ito/mahjong_app/.cursor/debug.log'
try:
    with open(log_path, 'a') as f:
        f.write(json.dumps({'sessionId': 'debug-session', 'runId': 'run1', 'hypothesisId': 'A', 'location': 'views.py:27', 'message': 'create_room called', 'data': {'method': request.method}, 'timestamp': int(time.time() * 1000)}) + '\n')
except: pass
```

**説明**: デバッグログがハードコードされたパスに書き込まれています。本番環境では存在しないパスへの書き込みが失敗する可能性があります。また、`except: pass`によりエラーが隠蔽されています。

**推奨事項**:
- デバッグログを削除するか、Djangoのロギングシステムを使用してください。
- 本番環境ではデバッグログを無効化してください。

### 4. 環境変数のデフォルト値 ⚠️ **MEDIUM**

**場所**: `mahjong_project/settings.py` (16行目)

**問題**:
```16:16:mahjong_project/settings.py
DEBUG = os.environ.get('DEBUG', 'True') == 'True'
```

**説明**: DEBUGのデフォルト値が`'True'`になっています。環境変数が設定されていない場合、本番環境でもデバッグモードが有効になる可能性があります。

**推奨事項**:
- デフォルト値を`'False'`に変更してください。
- 本番環境では必ず環境変数`DEBUG=False`を設定してください。

### 5. 入力バリデーションの不十分さ ⚠️ **MEDIUM**

**問題**: 一部の入力値に対してバリデーションが実装されていますが、以下の点で改善の余地があります：

1. **プレイヤー名の文字種チェック**: 現在は長さのみチェックしていますが、特殊文字やスクリプトタグのチェックがありません。
2. **数値入力のエラーハンドリング**: `int()`や`float()`の変換時に例外が発生する可能性があります（一部はtry-exceptで処理されていますが、一貫性がありません）。

**推奨事項**:
- Django Formsを使用して入力バリデーションを統一してください。
- XSS対策として、テンプレートで`|escape`フィルタを使用しているか確認してください。

### 6. 部屋コードの推測可能性 ⚠️ **LOW-MEDIUM**

**場所**: `mahjong/models.py` (6-20行目)

**問題**: 部屋コードは6桁の英数字で生成されています。総当たり攻撃により推測可能です。

**推奨事項**:
- 部屋コードの長さを増やすか、より強力なランダム生成を使用してください。
- レート制限を実装して、連続した試行を制限してください。

## 低リスクの問題（Low）

### 7. セッション管理の設定

**現在の設定**: 
- `SESSION_COOKIE_HTTPONLY = True` ✅
- `SESSION_COOKIE_AGE = 86400` (24時間) ✅
- 本番環境で`SESSION_COOKIE_SECURE = True` ✅

**評価**: 適切に設定されています。

### 8. CSRF保護の設定

**現在の設定**:
- `CSRF_COOKIE_HTTPONLY = True` ✅
- 本番環境で`CSRF_COOKIE_SECURE = True` ✅
- `CSRF_TRUSTED_ORIGINS`が環境変数から設定可能 ✅

**評価**: 適切に設定されています。ただし、一部のビューで`@csrf_exempt`が使用されているため、注意が必要です。

### 9. セキュリティヘッダー

**現在の設定**:
- `SECURE_BROWSER_XSS_FILTER = True` ✅
- `SECURE_CONTENT_TYPE_NOSNIFF = True` ✅
- `X_FRAME_OPTIONS = 'DENY'` ✅
- `SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'` ✅

**評価**: 適切に設定されています。

### 10. SQLインジェクション対策

**評価**: Django ORMを使用しているため、SQLインジェクションのリスクは低いです。✅

### 11. パスワードバリデーション

**評価**: Djangoのデフォルトパスワードバリデーターが設定されています。ただし、このアプリでは認証機能が使用されていないため、現時点では関係ありません。

## 推奨される改善アクション

### 優先度: 高

1. **CSRF保護の修正**: `@csrf_exempt`を削除（GETリクエストのみのビューでは不要）
2. **認証・認可の実装**: 部屋へのアクセス制御を追加
3. **デバッグログの削除**: 本番環境用のコードからデバッグログを削除
4. **DEBUG設定の修正**: デフォルト値を`False`に変更

### 優先度: 中

5. **入力バリデーションの強化**: Django Formsの使用を検討
6. **部屋コードの強化**: より長いコードまたはレート制限の実装
7. **エラーハンドリングの改善**: 一貫したエラーハンドリングの実装

### 優先度: 低

8. **ロギングの改善**: Djangoのロギングシステムの使用
9. **監査ログ**: 重要な操作（削除など）のログ記録

## 結論

このアプリケーションは基本的なセキュリティ設定（CSRF、セキュリティヘッダー、セッション管理）は適切に実装されています。しかし、認証・認可の欠如とCSRF保護の無効化が主な懸念事項です。特に、部屋コードを知っている誰でもデータを閲覧・編集・削除できる点は、本番環境で使用する前に改善が必要です。

## 次のステップ

1. 重大な問題（Critical/High）の修正を優先してください
2. 修正後、再度セキュリティチェックを実施してください
3. 本番環境にデプロイする前に、すべての推奨事項を確認してください

