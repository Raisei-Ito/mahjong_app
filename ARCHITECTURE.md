# アーキテクチャドキュメント

このドキュメントでは、麻雀スコア管理アプリケーションのアーキテクチャと設計思想について詳しく説明します。

---

## システムアーキテクチャ

### 全体構成

```
┌─────────────┐
│   Client    │ (ブラウザ)
│  (HTMX)     │
└──────┬──────┘
       │ HTTP/HTTPS
       ▼
┌─────────────┐
│   Django    │ (WSGI Application)
│  (Gunicorn) │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  SQLite     │ (データベース)
└─────────────┘
```

### アーキテクチャの特徴

- **サーバーサイドレンダリング**: Django Templatesによる完全なSSR
- **軽量な非同期通信**: HTMXによる部分更新
- **シンプルな構成**: 追加のキャッシュサーバーやメッセージキューは不要

---

## データモデル設計

### エンティティ関係図

```
Room (部屋)
  ├── code: 6桁の英数字コード（一意）
  ├── rate_type: レート設定
  ├── sashi_uma_type: サシウマタイプ
  ├── starting_points: 持ち点
  ├── return_points: 返し点
  └── chip_point_rate: チップ換算率
      │
      ├── Player (プレイヤー) [1:N]
      │   ├── name: プレイヤー名
      │   └── order: 順番 (1-4)
      │       │
      │       └── ScoreRecord (スコア記録) [1:N]
      │           ├── score: 持ち点
      │           ├── chip_change: チップ増減
      │           ├── rank: 順位
      │           └── points: 計算されたポイント
      │
      └── Game (半荘) [1:N]
          ├── game_number: ゲーム番号
          └── ScoreRecord (スコア記録) [1:N]
```

### 設計思想

#### 正規化されたデータ構造

4つのエンティティに分離することで：
- **データの重複を排除**: 同じ情報を複数箇所に保存しない
- **整合性の保証**: 外部キー制約により、不正なデータの作成を防止
- **拡張性の確保**: 新しい機能を追加する際も既存の構造を壊さない

#### ビジネスロジックの集約

麻雀のスコア計算ロジックをモデルのプロパティメソッドに集約：

```python
@property
def uma_1st(self):
    """1位ウマ（サシウマから計算）"""
    _, uma_3_4 = self._get_sashi_uma_values()
    return uma_3_4
```

**メリット**:
- 計算ロジックが一箇所に集約され、変更が容易
- ビュー関数がシンプルになり、可読性が向上
- テストが書きやすい

---

## ビュー層の設計

### URLルーティング

```
/                           → index (部屋作成)
/room/<code>/               → dashboard (ダッシュボード)
/room/<code>/setup/         → room_setup (プレイヤー登録)
/room/<code>/settings/      → room_settings (部屋設定)
/room/<code>/record/        → record_score (スコア記録)
/room/<code>/partials/game-list/ → game_list_partial (HTMX用)
/room/<code>/partials/player-stats/ → player_stats_partial (HTMX用)
```

### RESTfulな設計

URL構造が直感的で、リソース指向の設計になっています。

### ビュー関数の責務

各ビュー関数は単一の責務を持ち、明確に分離されています：

- **index**: 部屋作成フォームの表示と処理
- **dashboard**: ゲーム履歴と累計成績の表示
- **room_setup**: プレイヤー登録
- **room_settings**: 部屋設定（レート、サシウマ、チップ換算率など）
- **record_score**: スコア記録の入力と保存（トランザクション管理）
- **game_list_partial**: HTMX用のゲーム履歴パーシャル
- **player_stats_partial**: HTMX用のプレイヤー統計パーシャル

### トランザクション管理

スコア記録時は`transaction.atomic()`を使用してデータ整合性を保証：

```python
@transaction.atomic
def record_score(request, code):
    # スコア記録処理
    # エラー時は自動ロールバック
```

**実装のポイント**:
- 複数のデータベース操作を1つのトランザクション内で実行
- エラー発生時はすべての変更がロールバック
- データの不整合を防ぐ

---

## フロントエンド設計

### HTMXによる非同期更新

**実装の詳細**:
- `hx-trigger="every 3m"`属性で3分ごとに自動更新
- パーシャルテンプレートによる部分更新
- ページ全体のリロードなしで最新情報を表示
- `hx-swap`属性によるDOM更新方法の制御

**技術的な考慮事項**:
- サーバーサイドレンダリングとの相性の良さ
- 状態管理の複雑さを避けつつ、動的なUIを実現
- ネットワーク負荷の最小化

### レスポンシブデザイン

**Bootstrap 5の活用**:
- グリッドシステムによる柔軟なレイアウト
- モバイルファーストの設計思想
- ブレークポイントを考慮したUI設計

### ユーザー体験の向上

- **入力バリデーション**: クライアントサイドとサーバーサイドの両方で実装
- **エラーハンドリング**: 具体的で分かりやすいエラーメッセージ
- **ローディング状態**: HTMXのローディングインジケーターによる視覚的フィードバック

---

## セキュリティ設計

### 認証・認可

現在は認証機能なし（部屋コードでアクセス制御）

**設計判断**:
- 小規模なアプリケーションのため、認証の複雑さを避けた
- 部屋コードによる簡易的なアクセス制御で十分
- 将来的な拡張: Django認証システムの統合を検討

### セキュリティ対策

- **CSRF保護**: Django標準のCSRFミドルウェア
- **XSS対策**: テンプレートエスケープによる自動的なXSS防止
- **SQLインジェクション対策**: Django ORMによる安全なクエリ実行
- **セキュアなCookie**: 本番環境でHTTPSのみでCookieを送信
- **入力バリデーション**: サーバーサイドでの厳格なバリデーション

---

## パフォーマンス最適化

### データベース

- **インデックス**: 外部キーに自動インデックスが作成される
- **クエリ最適化**: `select_related()`、`prefetch_related()`の使用を検討
- **WALモード**: SQLiteのWALモードを有効化（マルチプロセス対応）

### 静的ファイル

- **WhiteNoise**: 本番環境での静的ファイル配信
- **圧縮**: 静的ファイルの圧縮とキャッシュ
- **CDN**: 将来的にはCDNの導入を検討

### キャッシュ戦略

現在はキャッシュを使用していませんが、将来的には以下を検討：
- ゲーム履歴のキャッシュ
- プレイヤー統計のキャッシュ

---

## デプロイメント

### デプロイプラットフォーム: Render

**選定理由**:
- GitHubと連携した自動デプロイによるCI/CDの簡素化
- 無料プランで個人開発に適している
- SSL証明書の自動発行・更新
- 環境変数の簡単な管理

### デプロイ設定の詳細

- **ビルドコマンド**: `pip install -r requirements.txt && python manage.py collectstatic --noinput`
- **起動コマンド**: `gunicorn mahjong_project.wsgi:application`
- **Pythonバージョン**: 3.11
- **静的ファイル**: WhiteNoiseによる配信（`render.yaml`で設定）

### 本番環境の設定

- **DEBUG**: False（セキュリティのため）
- **セキュリティヘッダー**: X-Frame-Options, X-Content-Type-Options等を設定
- **静的ファイル**: WhiteNoiseで配信（圧縮とキャッシュ）
- **データベース**: SQLite（小規模運用に適している）
- **セッション管理**: セキュアなCookie設定

---

## 今後の拡張予定

1. **認証機能**: ユーザー登録・ログイン機能の追加
2. **API**: RESTful APIの提供
3. **リアルタイム通信**: WebSocketによるリアルタイム更新
4. **統計機能**: より詳細な統計分析
5. **データベース**: ユーザー数が増加した場合のPostgreSQLへの移行

---

## 技術的な課題と改善点

### 現在の課題

- **テストカバレッジ**: より包括的なテストの追加が必要
- **パフォーマンス**: クエリ最適化のさらなる改善（`select_related()`、`prefetch_related()`の活用）
- **エラーハンドリング**: より詳細なエラーログとモニタリングの実装
- **キャッシュ戦略**: ゲーム履歴や統計情報のキャッシュ導入を検討

### 将来の改善予定

- **認証機能**: Django認証システムの統合
- **API**: RESTful APIの提供によるモバイルアプリ対応
- **リアルタイム通信**: WebSocketによるより高速な更新
- **データベース**: ユーザー数増加時のPostgreSQLへの移行

---

## 参考資料

- [Django公式ドキュメント](https://docs.djangoproject.com/)
- [HTMX公式ドキュメント](https://htmx.org/)
- [Bootstrap 5公式ドキュメント](https://getbootstrap.com/docs/5.0/)

---

**このアーキテクチャは、小規模なWebアプリケーションに適したシンプルで保守性の高い設計を目指しています。**
