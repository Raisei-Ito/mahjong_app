{% extends 'mahjong/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card fade-in">
            <div class="card-header">
                <h3><i class="bi bi-gear-fill me-2"></i>部屋設定</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    部屋コード: <strong class="fs-5">{{ room.code }}</strong>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- ウマ設定 -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-trophy me-2"></i>ウマ設定</h5>
                        <div class="mb-3">
                            <label for="sashi_uma_type" class="form-label fw-bold">ウマタイプ</label>
                            <select class="form-select" id="sashi_uma_type" name="sashi_uma_type" onchange="toggleCustomSashiUma()">
                                {% for value, label in room.SASHI_UMA_CHOICES %}
                                <option value="{{ value }}" {% if room.sashi_uma_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row" id="custom_sashi_uma_div" style="display: {% if room.sashi_uma_type == 'custom' %}block{% else %}none{% endif %};">
                            <div class="col-md-6 mb-3">
                                <label for="sashi_uma_1_2" class="form-label fw-bold">
                                    サシウマ 1-2位
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="sashi_uma_1_2" 
                                       name="sashi_uma_1_2" 
                                       value="{{ room.sashi_uma_1_2 }}"
                                       min="0"
                                       step="1">
                                <small class="text-muted">1位と2位の差（例: 5）</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sashi_uma_3_4" class="form-label fw-bold">
                                    サシウマ 3-4位
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="sashi_uma_3_4" 
                                       name="sashi_uma_3_4" 
                                       value="{{ room.sashi_uma_3_4 }}"
                                       min="0"
                                       step="1">
                                <small class="text-muted">3位と4位の差（例: 10）</small>
                            </div>
                        </div>
                        <div class="alert alert-secondary">
                            <strong>現在のウマ:</strong><br>
                            1位: +{{ room.uma_1st }}pt, 
                            2位: +{{ room.uma_2nd }}pt, 
                            3位: {{ room.uma_3rd }}pt, 
                            4位: {{ room.uma_4th }}pt
                        </div>
                    </div>
                    
                    <!-- レート設定（参考情報） -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-calculator me-2"></i>レート設定（参考）</h5>
                        <div class="alert alert-info mb-3">
                            <small>
                                <strong>レートの表記について:</strong><br>
                                「(25000/35000)」は「(持ち点/返し点)」を表します。<br>
                                レートタイプは参考情報として表示されますが、実際の計算には下記の「持ち点」と「返し点」の設定値が使用されます。
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="rate_type" class="form-label fw-bold">レートタイプ（参考）</label>
                            <select class="form-select" id="rate_type" name="rate_type" onchange="updatePointsFromRate()">
                                {% for value, label in room.RATE_CHOICES %}
                                <option value="{{ value }}" {% if room.rate_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">レートタイプを選択すると、持ち点と返し点が自動的に設定されます（上書き可能）</small>
                        </div>
                    </div>
                    
                    <!-- 持ち点・返し点設定 -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-123 me-2"></i>持ち点・返し点設定</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="starting_points" class="form-label fw-bold">持ち点</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="starting_points" 
                                       name="starting_points" 
                                       value="{{ room.starting_points }}"
                                       min="0"
                                       max="1000000"
                                       step="1000"
                                       required>
                                <small class="text-muted">各プレイヤーの初期持ち点（デフォルト: 25000点）</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="return_points" class="form-label fw-bold">返し点</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="return_points" 
                                       name="return_points" 
                                       value="{{ room.return_points }}"
                                       min="0"
                                       max="1000000"
                                       step="1000"
                                       required>
                                <small class="text-muted">ポイント計算の基準点（デフォルト: 30000点）</small>
                            </div>
                        </div>
                        <div class="alert alert-secondary">
                            <strong>現在の設定:</strong><br>
                            持ち点: {{ room.starting_points }}点<br>
                            返し点: {{ room.return_points }}点<br>
                            オカ: +{{ room.oka_points }}pt (1位のみ)
                        </div>
                    </div>
                    
                    <!-- チップ換算率設定 -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-coin me-2"></i>チップ換算率設定</h5>
                        <div class="mb-3">
                            <label for="chip_point_rate" class="form-label fw-bold">チップ1枚あたりのポイント（pt）</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="chip_point_rate" 
                                   name="chip_point_rate" 
                                   value="{{ room.chip_point_rate }}"
                                   min="0"
                                   max="1000"
                                   step="0.1"
                                   required>
                            <small class="text-muted">チップ1枚を何ptに換算するか（例: 5pt = チップ1枚 = 500円相当）</small>
                        </div>
                        <div class="alert alert-secondary">
                            <strong>現在の設定:</strong><br>
                            チップ1枚 = {{ room.chip_point_rate }}pt
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'mahjong:room_dashboard' room.code %}" class="btn btn-secondary btn-lg flex-fill">
                            <i class="bi bi-arrow-left me-2"></i>キャンセル
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg flex-fill">
                            <i class="bi bi-check-circle me-2"></i>設定を保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// レートタイプから持ち点と返し点を自動設定
function updatePointsFromRate() {
    const rateType = document.getElementById('rate_type').value;
    const startingPointsInput = document.getElementById('starting_points');
    const returnPointsInput = document.getElementById('return_points');
    
    const rateMap = {
        'no': { starting: 25000, return: 25000 },
        'ten1': { starting: 25000, return: 26000 },
        'ten2': { starting: 25000, return: 27000 },
        'ten3': { starting: 25000, return: 28000 },
        'ten5': { starting: 25000, return: 30000 },
        'pin': { starting: 25000, return: 35000 },
        'ryanpin': { starting: 25000, return: 45000 },
        'upin': { starting: 25000, return: 75000 },
        'dekapin': { starting: 25000, return: 125000 },
        'custom': { starting: 25000, return: 30000 }
    };
    
    const points = rateMap[rateType];
    if (points) {
        startingPointsInput.value = points.starting;
        returnPointsInput.value = points.return;
    }
}

function toggleCustomSashiUma() {
    const sashiUmaType = document.getElementById('sashi_uma_type').value;
    const customSashiUmaDiv = document.getElementById('custom_sashi_uma_div');
    if (sashiUmaType === 'custom') {
        customSashiUmaDiv.style.display = 'block';
    } else {
        customSashiUmaDiv.style.display = 'none';
    }
}

// Initial call to set correct display state on page load
document.addEventListener('DOMContentLoaded', () => {
    toggleCustomSashiUma();
});
</script>
{% endblock %}

